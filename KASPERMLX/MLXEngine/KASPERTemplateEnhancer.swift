/**
 * KASPER Template Enhancer
 * 
 * Enhanced template generation for more natural, flowing spiritual insights.
 * Eliminates rigid patterns and abrupt sentence endings.
 * Creates dynamic, personalized content that feels authentically spiritual.
 */

import Foundation

/// Enhanced template generator for natural spiritual language
struct KASPERTemplateEnhancer {
    
    // MARK: - Enhanced Insight Templates
    
    /// Generate guidance insights with natural language flow
    static func generateGuidanceInsight(
        component: String,
        reference: String,
        guidance: String
    ) -> String {
        let templates = [
            // Flowing narrative style
            "🌟 As \(component) awakens within you, \(reference) becomes a beacon of clarity. The universe invites you to \(guidance), allowing this sacred energy to illuminate your path forward.",
            
            // Wisdom teacher style
            "🌟 Today's spiritual landscape reveals \(component) radiating through \(reference). This cosmic alignment suggests that when you \(guidance), profound transformation naturally unfolds.",
            
            // Mystical oracle style
            "🌟 The cosmic tapestry weaves \(component) into your awareness, highlighting \(reference) as your spiritual compass. Now is the time to \(guidance) and witness the magic that emerges.",
            
            // Gentle guide style
            "🌟 Notice how \(component) gently flows through \(reference), creating sacred space for growth. By choosing to \(guidance), you align with the universe's loving intention for your journey.",
            
            // Empowering mentor style
            "🌟 Your spiritual essence channels \(component) through \(reference) with remarkable clarity. This powerful moment calls you to \(guidance), stepping fully into your divine purpose.",
            
            // Cosmic storyteller style
            "🌟 Within the grand cosmic dance, \(component) emerges through \(reference) like starlight through crystal. The universe whispers: \(guidance), and watch as synchronicities bloom around you.",
            
            // Sacred invitation style
            "🌟 Today brings a sacred invitation as \(component) activates \(reference) within your energy field. Answer this cosmic call to \(guidance), knowing the universe supports every step.",
            
            // Spiritual architect style
            "🌟 You're architecting your reality as \(component) builds through \(reference). The cosmic blueprint reveals it's time to \(guidance), constructing a foundation of spiritual abundance.",
            
            // Divine messenger style
            "🌟 A message arrives through \(component), delivered via \(reference) straight to your soul. The guidance is clear: \(guidance), and trust the unfolding of divine timing.",
            
            // Energy weaver style
            "🌟 Feel how \(component) weaves through \(reference), creating patterns of possibility. As you \(guidance), these energetic threads strengthen into manifestation."
        ]
        
        return templates.randomElement() ?? templates[0]
    }
    
    /// Generate reflection insights with contemplative depth
    static func generateReflectionInsight(
        component: String,
        reference: String,
        guidance: String
    ) -> String {
        let templates = [
            // Deep contemplation style
            "🌙 As \(component) illuminates your inner landscape, consider how \(reference) has been guiding you all along. What shifts when you \(guidance) with conscious awareness?",
            
            // Mirror of wisdom style
            "🌙 The mirror of consciousness reflects \(component) through \(reference), revealing hidden truths. Take a moment to \(guidance) and observe what wisdom emerges from stillness.",
            
            // Journey reflection style
            "🌙 Your spiritual journey has brought \(component) into focus through \(reference). Reflect on how choosing to \(guidance) might reshape your understanding of this sacred path.",
            
            // Inner dialogue style
            "🌙 Within the quiet spaces of your soul, \(component) speaks through \(reference). Listen deeply as you \(guidance), allowing inner wisdom to surface naturally.",
            
            // Sacred pause style
            "🌙 This moment of reflection unveils \(component) working through \(reference) in mysterious ways. What happens when you pause to \(guidance) with complete presence?",
            
            // Wisdom integration style
            "🌙 Notice the subtle ways \(component) has been expressing through \(reference) recently. As you \(guidance), observe how past experiences suddenly make perfect sense.",
            
            // Soul questioning style
            "🌙 Your soul poses a question through \(component), using \(reference) as its voice. How might your life transform if you fully \(guidance) starting from this moment?",
            
            // Pattern recognition style
            "🌙 Patterns emerge as \(component) dances with \(reference) in your awareness. Reflect on times when choosing to \(guidance) has brought unexpected blessings.",
            
            // Inner compass style
            "🌙 Your inner compass aligns with \(component) through \(reference), pointing toward truth. What direction emerges when you sincerely \(guidance)?",
            
            // Sacred memory style
            "🌙 Memories surface as \(component) activates \(reference) within your consciousness. Remember moments when you chose to \(guidance) and felt divinely supported."
        ]
        
        return templates.randomElement() ?? templates[0]
    }
    
    /// Generate affirmation insights with empowering energy
    static func generateAffirmationInsight(
        component: String,
        reference: String,
        guidance: String
    ) -> String {
        let templates = [
            // Power declaration style
            "💫 I am a sacred vessel for \(component), expressing magnificently through \(reference). I choose to \(guidance) with unwavering faith in my spiritual power.",
            
            // Divine embodiment style
            "💫 I embody \(component) as it flows through \(reference) with grace and purpose. Each day I \(guidance), stepping deeper into my divine truth.",
            
            // Cosmic alignment style
            "💫 I align perfectly with \(component), allowing \(reference) to guide my every step. I joyfully \(guidance), knowing the universe conspires in my favor.",
            
            // Sacred commitment style
            "💫 I commit to honoring \(component) as it expresses through \(reference). With courage and clarity, I \(guidance), trusting my spiritual authority.",
            
            // Manifestation mastery style
            "💫 I masterfully channel \(component) through \(reference) into physical reality. As I \(guidance), miracles naturally unfold in my experience.",
            
            // Divine remembrance style
            "💫 I remember my true nature as \(component) awakens \(reference) within me. I confidently \(guidance), reclaiming my spiritual sovereignty.",
            
            // Quantum creator style
            "💫 I consciously create with \(component), using \(reference) as my divine instrument. When I \(guidance), reality reshapes to match my highest vision.",
            
            // Soul celebration style
            "💫 I celebrate as \(component) dances through \(reference) in perfect harmony. I enthusiastically \(guidance), embracing the joy of spiritual expansion.",
            
            // Infinite potential style
            "💫 I access infinite potential through \(component), channeled via \(reference). I fearlessly \(guidance), knowing all possibilities exist within me.",
            
            // Sacred activation style
            "💫 I activate \(component) through \(reference) with divine intention. As I \(guidance), every cell in my being resonates with spiritual truth."
        ]
        
        return templates.randomElement() ?? templates[0]
    }
    
    /// Generate prediction insights with mystical foresight
    static func generatePredictionInsight(
        component: String,
        reference: String,
        guidance: String
    ) -> String {
        let templates = [
            // Oracle vision style
            "🔮 The cosmic winds carry \(component) through \(reference) toward a pivotal moment ahead. As you \(guidance), watch for synchronicities that confirm you're on the right path.",
            
            // Timeline glimpse style
            "🔮 Future timelines converge as \(component) strengthens \(reference) within your field. Those who \(guidance) will find doors opening that seemed permanently closed.",
            
            // Destiny weaving style
            "🔮 Destiny weaves \(component) through \(reference), preparing you for what's coming. The cosmos suggests you \(guidance) to align with approaching opportunities.",
            
            // Prophetic whisper style
            "🔮 Ancient wisdom speaks: when \(component) flows through \(reference), transformation is imminent. Prepare by choosing to \(guidance) before the cosmic tide turns.",
            
            // Quantum possibility style
            "🔮 Quantum fields shift as \(component) activates \(reference) in your reality. The probability increases for positive outcomes when you \(guidance) with intention.",
            
            // Cosmic forecast style
            "🔮 The spiritual forecast shows \(component) intensifying through \(reference) in coming cycles. Those who \(guidance) will ride this wave with grace and ease.",
            
            // Sacred timing style
            "🔮 Divine timing aligns \(component) with \(reference) for a reason yet to be revealed. Trust that as you \(guidance), perfect orchestration unfolds.",
            
            // Vision quest style
            "🔮 Visions arise showing \(component) transforming \(reference) in unexpected ways. The key to navigating this shift: \(guidance) with an open heart.",
            
            // Karmic preview style
            "🔮 Karmic patterns reveal \(component) working through \(reference) to complete a cycle. Liberation comes to those who \(guidance) without hesitation.",
            
            // Stellar alignment style
            "🔮 Stellar configurations amplify \(component) through \(reference) in the days ahead. Maximum benefit flows to those who \(guidance) during this cosmic window."
        ]
        
        return templates.randomElement() ?? templates[0]
    }
    
    // MARK: - Enhanced Sentence Endings
    
    /// Create natural sentence endings that flow smoothly
    static func enhanceGuidanceEnding(_ guidance: String) -> String {
        // Remove forced capitalization and add flowing connectors
        let cleanGuidance = guidance.lowercased()
            .trimmingCharacters(in: .whitespacesAndNewlines)
            .trimmingCharacters(in: CharacterSet(charactersIn: ".!?"))
        
        let endings = [
            ", allowing divine wisdom to guide each step",
            ", trusting the sacred unfolding of your path",
            ", knowing the universe supports your journey",
            ", as spiritual doors open before you",
            ", embracing the magic of this moment",
            ", while cosmic forces align in your favor",
            ", and watch miracles naturally unfold",
            ", feeling the universe's loving presence",
            ", as your spiritual power awakens fully",
            ", letting sacred energy flow through you"
        ]
        
        return cleanGuidance + endings.randomElement()!
    }
    
    // MARK: - Cosmic Timing Integration
    
    /// Add time-specific spiritual context
    static func addCosmicTimingContext(baseInsight: String, hour: Int) -> String {
        let timingPrefixes: [String]
        
        switch hour {
        case 4...6:
            timingPrefixes = [
                "In these sacred pre-dawn hours, ",
                "As the veil between worlds thins at dawn, ",
                "During this mystical morning threshold, "
            ]
        case 7...11:
            timingPrefixes = [
                "As morning light activates new possibilities, ",
                "In this time of fresh beginnings, ",
                "While the day's energy builds momentum, "
            ]
        case 12...16:
            timingPrefixes = [
                "At the height of solar power, ",
                "In this moment of peak manifestation, ",
                "As the sun illuminates your path, "
            ]
        case 17...20:
            timingPrefixes = [
                "As daylight transforms into twilight, ",
                "In this sacred transition time, ",
                "While the day's lessons integrate, "
            ]
        case 21...23, 0...3:
            timingPrefixes = [
                "Under the mystical night sky, ",
                "In these hours of deep spiritual connection, ",
                "As lunar wisdom fills the darkness, "
            ]
        default:
            timingPrefixes = ["In this sacred moment, "]
        }
        
        return (timingPrefixes.randomElement() ?? "") + baseInsight.lowercaseFirstLetter()
    }
    
    // MARK: - Relationship Compatibility Templates
    
    /// Generate relationship compatibility insights
    static func generateRelationshipInsight(
        number1: Int,
        number2: Int,
        moonPhase: String? = nil
    ) -> String {
        let compatibility = calculateCompatibility(number1, number2)
        let synergyType = determineSynergyType(number1, number2)
        
        let templates = [
            "💞 These two souls create \(synergyType) together. Number \(number1) brings \(getNumberGift(number1)), while number \(number2) offers \(getNumberGift(number2)). This combination suggests \(compatibility) that deepens through conscious spiritual practice.",
            
            "💞 A sacred dance unfolds between \(getNumberArchetype(number1)) and \(getNumberArchetype(number2)) energies. Together, they weave \(synergyType), creating \(compatibility) that transcends ordinary connection.",
            
            "💞 When \(number1)'s \(getNumberElement(number1)) meets \(number2)'s \(getNumberElement(number2)), \(synergyType) emerges. This spiritual chemistry indicates \(compatibility), inviting both souls to grow through divine mirror work.",
            
            "💞 The cosmic blueprint reveals \(synergyType) between these spiritual signatures. Number \(number1)'s \(getNumberGift(number1)) harmonizes with number \(number2)'s \(getNumberGift(number2)), manifesting \(compatibility) with transformative potential.",
            
            "💞 These numbers create a spiritual alchemy of \(synergyType). The universe celebrates as \(getNumberArchetype(number1)) consciousness merges with \(getNumberArchetype(number2)) wisdom, birthing \(compatibility) that serves both souls' evolution."
        ]
        
        var insight = templates.randomElement() ?? templates[0]
        
        // Add moon phase context if available
        if let moon = moonPhase {
            let moonContext = " The \(moon) amplifies this connection's \(getMoonInfluence(moon)) qualities."
            insight += moonContext
        }
        
        return insight
    }
    
    private static func calculateCompatibility(_ num1: Int, _ num2: Int) -> String {
        let sum = (num1 + num2) % 9
        switch sum {
        case 1, 5, 9:
            return "powerful spiritual resonance"
        case 2, 6:
            return "harmonious heart connection"
        case 3, 7:
            return "creative mystical synergy"
        case 4, 8:
            return "grounding manifestation power"
        default:
            return "unique transformative bond"
        }
    }
    
    private static func determineSynergyType(_ num1: Int, _ num2: Int) -> String {
        let difference = abs(num1 - num2)
        switch difference {
        case 0:
            return "mirror soul reflection"
        case 1, 2:
            return "complementary harmony"
        case 3, 4:
            return "dynamic growth catalyst"
        case 5, 6:
            return "transformative polarity"
        default:
            return "sacred mystery"
        }
    }
    
    private static func getNumberGift(_ number: Int) -> String {
        switch number {
        case 1: return "pioneering leadership"
        case 2: return "harmonious collaboration"
        case 3: return "creative expression"
        case 4: return "stable foundations"
        case 5: return "adventurous transformation"
        case 6: return "nurturing wisdom"
        case 7: return "mystical insight"
        case 8: return "manifestation mastery"
        case 9: return "universal compassion"
        default: return "unique spiritual gifts"
        }
    }
    
    private static func getNumberArchetype(_ number: Int) -> String {
        switch number {
        case 1: return "Pioneer"
        case 2: return "Diplomat"
        case 3: return "Creative"
        case 4: return "Builder"
        case 5: return "Explorer"
        case 6: return "Nurturer"
        case 7: return "Mystic"
        case 8: return "Achiever"
        case 9: return "Humanitarian"
        default: return "Unique"
        }
    }
    
    private static func getNumberElement(_ number: Int) -> String {
        switch number {
        case 1, 5, 9: return "transformative fire"
        case 2, 6: return "flowing water"
        case 3, 7: return "expansive air"
        case 4, 8: return "grounding earth"
        default: return "ethereal spirit"
        }
    }
    
    private static func getMoonInfluence(_ phase: String) -> String {
        switch phase.lowercased() {
        case "new moon": return "seed-planting"
        case "waxing crescent": return "growth-nurturing"
        case "first quarter": return "action-taking"
        case "waxing gibbous": return "refinement"
        case "full moon": return "illuminating"
        case "waning gibbous": return "gratitude"
        case "last quarter": return "releasing"
        case "waning crescent": return "surrendering"
        default: return "mystical"
        }
    }
    
    // MARK: - Cosmic Timing Templates
    
    /// Generate cosmic timing insights
    static func generateCosmicTimingInsight(
        planetaryEnergy: String? = nil,
        moonPhase: String? = nil,
        astrologicalEvent: String? = nil
    ) -> String {
        var components: [String] = []
        
        if let planet = planetaryEnergy {
            components.append("\(planet)'s influence")
        }
        
        if let moon = moonPhase {
            components.append("the \(moon)")
        }
        
        if let event = astrologicalEvent {
            components.append(event)
        }
        
        let cosmicContext = components.isEmpty ? "current cosmic energies" : components.joined(separator: " combined with ")
        
        let templates = [
            "⏰ The cosmic clock reveals a powerful window of opportunity. With \(cosmicContext) active, the universe invites bold spiritual action. This is your moment to step through the portal of transformation that's been waiting for your readiness.",
            
            "⏰ Divine timing orchestrates \(cosmicContext) to support your soul's evolution. The celestial symphony plays your song - dance with it, and watch as synchronized events align to guide your path forward.",
            
            "⏰ Sacred chronology indicates \(cosmicContext) creating a unique spiritual gateway. What seemed impossible yesterday becomes achievable today. Trust this cosmic green light and move forward with confidence.",
            
            "⏰ The universe's perfect timing brings \(cosmicContext) into alignment with your spiritual blueprint. This rare configuration won't last forever - embrace its gifts while the cosmic door remains open.",
            
            "⏰ Celestial mechanics position \(cosmicContext) as your spiritual catalyst. The cosmos has been preparing this moment specifically for your growth. Answer the call with courageous action."
        ]
        
        return templates.randomElement() ?? templates[0]
    }
}

// MARK: - Helper Extensions

private extension String {
    func lowercaseFirstLetter() -> String {
        return prefix(1).lowercased() + dropFirst()
    }
    
    func capitalizeFirstLetter() -> String {
        return prefix(1).uppercased() + dropFirst()
    }
}